{% extends "base.html" %}

{% block content %}


{% if not db_exists %}

    {% if session.get('is_admin') %}
    <p style="margin:20px; opacity:0.7;">Database doesn't exist yet. Please use the button below to initialize it.</p>
    <form action="{{ url_for('init_db') }}" method="POST" style="margin-bottom: 15px;">
        <button type="submit" class="admin-btn">
            Initialize Database
        </button>
    </form>
    {% else %}
    <p style="margin:20px; opacity:0.7;">Database doesn't exist yet. Please login as admin to initialize it.</p>

    {% endif %}

{% endif %}


{% if db_exists %}
<form action="{{ url_for('add_item_route', item_type=item_type) }}" method="POST">
    <input type="hidden" name="thumbnail" id="item-thumbnail">
    <input type="text" name="title" id="item-title" placeholder="Title" required autocomplete="off">
    <div id="autocomplete-results" class="autocomplete-results"></div>
    <input type="text" name="creator" id="item-creator" placeholder="Creator">
    <input type="text" name="category" placeholder="Category">
    <button type="submit">Add a new {{ item_type[:-1] }}</button>
</form>
{% else %}
<p style="margin:20px; opacity:0.5;">Cannot add items because database doesn't exist yet.</p>
{% endif %}

<h2>{{ item_type | capitalize }} list</h2>

<div class="search-controls-wrapper">
    <label>üîç Search:</label>
    <input type="text" id="custom-search" placeholder="Enter phrase..." style="width:250px; padding:5px; margin-left:10px;">

    <div class="column-search-checkboxes">
        <label style="margin-right: 10px;"><strong>All</strong><input type="checkbox" id="select-all-cols" checked></label>

        <label>ID<input type="checkbox" class="col-checkbox" checked data-column="0"></label>
        <label>Title<input type="checkbox" class="col-checkbox" checked data-column="1"></label>
        <label>Creator<input type="checkbox" class="col-checkbox" checked data-column="2"></label>
        <label>Category<input type="checkbox" class="col-checkbox" checked data-column="3"></label>

        <label>Status:
            <select id="status-filter" data-column="4">
                <option value="">All</option>
                <option value="To Read">To Read</option>
                <option value="Completed">Completed</option>
            </select>
        </label>

        <div class="rating-slider-container">
            <label>Rating:</label>
            <div class="slider-wrapper">
                <input type="range" id="rating-min" min="0" max="10" value="0" step="1">
                <input type="range" id="rating-max" min="0" max="10" value="10" step="1">
                <div class="slider-track"></div>
            </div>
            <span id="rating-display">0 - 10</span>
        </div>
    </div>
</div>

<table id="items-table" class="display">
    <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Creator</th>
            <th>Category</th>
            <th>Status</th>
            <th>Rating</th>
        </tr>
    </thead>

    <tbody>
    {% for item in items %}
        <tr data-id="{{ item['id'] }}">
            <td>{{ loop.index }}</td>
            <td>{{ item['title'] }}</td>
            <td>{{ item['creator'] }}</td>
            <td>{{ item['category'] }}</td>
            <td>{{ item['status'] }}</td>
            <td>{{ item['rating'] or '' }}</td>
        </tr>
    {% endfor %}
    </tbody>

</table>

<script>

    document.addEventListener("DOMContentLoaded", () => {
      const titleInput = document.getElementById("item-title");
      const creatorInput = document.getElementById("item-creator");
      const resultsBox = document.getElementById("autocomplete-results");
      let timer = null;

      // Tylko dla books - szukaj API, dla reszty autocomplete wy≈ÇƒÖczony
      const itemType = "{{ item_type }}";

      if (itemType === 'books') {
        titleInput.addEventListener("input", async function () {
          const query = this.value.trim();
          clearTimeout(timer);
          resultsBox.innerHTML = "";

          if (query.length < 2) return;

          timer = setTimeout(async () => {
            const timestamp = Date.now();
            const res = await fetch(`/search?q=intitle:${encodeURIComponent(query)}&_t=${timestamp}`);
            const data = await res.json();
            const results = data.results || [];

            if (results.length === 0) return;

            resultsBox.innerHTML = results
              .map(item => `
                <div class="autocomplete-item"
                     data-title="${item.title}"
                     data-creator="${(item.authors && item.authors[0]) || ''}"
                     data-category="${(item.categories && item.categories[0]) || ''}"
                     data-thumbnail="${item.thumbnail || ''}">
                  ${item.thumbnail ? `<img src="${item.thumbnail}" alt="">` : ""}
                  <div>
                    <strong>${item.title}</strong><br>
                    <small>${(item.authors && item.authors.join(", ")) || "Unknown author"}</small>
                  </div>
                </div>
              `)
              .join("");

            document.querySelectorAll(".autocomplete-item").forEach(item => {
              item.addEventListener("click", () => {
                titleInput.value = item.dataset.title;
                creatorInput.value = item.dataset.creator;
                document.querySelector('input[name="category"]').value = item.dataset.category || '';
                document.getElementById("item-thumbnail").value = item.dataset.thumbnail || '';
                resultsBox.innerHTML = "";
              });
            });
          }, 300);
        });

        document.addEventListener("click", (e) => {
          if (!resultsBox.contains(e.target) && e.target !== titleInput) {
            resultsBox.innerHTML = "";
          }
        });
      }
    });


$(document).ready(function() {
    var table = $('#items-table').DataTable({
        paging: true,
        searching: false,
        ordering: true,
        language: {},
        pageLength: 10,
        rowCallback: function(row, data) {
            $(row).css('cursor', 'pointer');
            $(row).off('click').on('click', function() {
                const itemId = $(row).data('id');
                window.location.href = `/item/${itemId}`;
            });
        }
    });

    //search bar with tickboxes
    function customFilter(){

        const searchTerm = $('#custom-search').val().toLowerCase();

        const checkedColumns = $('.col-checkbox:checked')
            .map(function() {return parseInt($(this).data('column')); })
            .get();

        const statusValue = $('#status-filter').val().toLowerCase();

        const minRating = parseFloat($('#rating-min').val()) || 0;
        const maxRating = parseFloat($('#rating-max').val()) || 10;

        const activeColumns = checkedColumns.length ? checkedColumns : [0,1,2,3,4,5];

        table.rows().every(function(){
           const rowData = this.data();

           const textMatch = activeColumns.some(col=>
               (rowData[col] || '').toString().toLowerCase().includes(searchTerm)
           );

           const statusMatch = !statusValue || (rowData[4] || '').toLowerCase() === statusValue;

            const rating = parseFloat(rowData[5]) || 0;
            const ratingMatch = rating >= minRating && rating <= maxRating;

           if ((textMatch || !searchTerm) && statusMatch && ratingMatch) {
               $(this.node()).show();
           } else {
               $(this.node()).hide();
           }
        });
    }

    function syncSelectAllState() {
        const totalCheckboxes = $('.col-checkbox').length;
        const checkedCount = $('.col-checkbox:checked').length;
        $('#select-all-cols').prop('checked', totalCheckboxes === checkedCount);
    }

    syncSelectAllState();

    $('#select-all-cols').on('change', function() {
        const isChecked = $(this).prop('checked');
        $('.col-checkbox').prop('checked', isChecked);
        customFilter();
    });

    $('.col-checkbox').on('change', function() {
        syncSelectAllState();
        customFilter();
    });

    $('#custom-search').on('keyup', customFilter);

    $('#status-filter').on('change', customFilter);

    const ratingMin = $('#rating-min');
    const ratingMax = $('#rating-max');
    const ratingDisplay = $('#rating-display');
    const sliderTrack = $('.slider-track');

    function updateSliderTrack() {
        const min = parseFloat(ratingMin.val());
        const max = parseFloat(ratingMax.val());
        const percentMin = (min / 10) * 100;
        const percentMax = (max / 10) * 100;
        sliderTrack.css({
            left: percentMin + '%',
            right: (100 - percentMax) + '%'
        });
        ratingDisplay.text(`${min} - ${max}`);
    }

    ratingMin.on('input', function() {
        if (parseFloat(ratingMin.val()) > parseFloat(ratingMax.val())) ratingMin.val(ratingMax.val());
        updateSliderTrack();
        customFilter();
    });

    ratingMax.on('input', function() {
        if (parseFloat(ratingMax.val()) < parseFloat(ratingMin.val())) ratingMax.val(ratingMin.val());
        updateSliderTrack();
        customFilter();
    });

    updateSliderTrack();
});
</script>

{% endblock %}