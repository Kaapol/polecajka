{% extends "base.html" %}

{% block content %}


{% if not db_exists %}

    {% if session.get('is_admin') %}
    <p style="margin:20px; opacity:0.7;">Database doesn't exist yet. Please use the button below to initialize it.</p>
    <form action="{{ url_for('init_books_db') }}" method="POST" style="margin-bottom: 15px;">
        <button type="submit" class="admin-btn">
            Initialize Books Database
        </button>
    </form>
    {% else %}
    <p style="margin:20px; opacity:0.7;">Database doesn't exist yet. Please login as admin to initialize it.</p>

    {% endif %}

{% endif %}


{% if db_exists %}
<form action="{{ url_for('add') }}" method="POST">
    <input type="text" name="title" id="book-title" placeholder="Title" required autocomplete="off">
    <div id="autocomplete-results" class="autocomplete-results"></div>
    <input type="text" name="author" id="book-author" placeholder="Author">
    <input type="text" name="category" placeholder="Category">
    <button type="submit">Add a new book</button>
</form>
{% else %}
<p style="margin:20px; opacity:0.5;">Cannot add books because database doesn't exist yet.</p>
{% endif %}

<h2>Book list</h2>

<div class="search-controls-wrapper">
    <label>üîç Search:</label>
    <input type="text" id="custom-search" placeholder="Enter phrase..." style="width:250px; padding:5px; margin-left:10px;">

    <div class="column-search-checkboxes">
        <label>ID<input type="checkbox" checked data-column="0"></label>
        <label>Title<input type="checkbox" checked data-column="1"></label>
        <label>Author<input type="checkbox" checked data-column="2"></label>
        <label>Category<input type="checkbox" checked data-column="3"></label>

        <!-- dropdown for status -->
        <label>Status:
            <select id="status-filter" data-column="4">
                <option value="">All</option>
                <option value="To Read">To Read</option>
                <option value="Completed">Completed</option>
            </select>
        </label>

        <!-- rating range slider -->
        <div class="rating-slider-container">
            <label>Rating:</label>
            <div class="slider-wrapper">
                <input type="range" id="rating-min" min="0" max="10" value="0" step="1">
                <input type="range" id="rating-max" min="0" max="10" value="10" step="1">
                <div class="slider-track"></div>
            </div>
            <span id="rating-display">0 - 10</span>
        </div>
    </div>
</div>

<table id="books-table" class="display">
    <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>Category</th>
            <th>Status</th>
            <th>Rating</th>
        </tr>
    </thead>

    <tbody>
    {% for book in books %}
        <tr data-id="{{ book['id'] }}">
            <td>{{ loop.index }}</td>
            <td>{{ book['title'] }}</td>
            <td>{{ book['author'] }}</td>
            <td>{{ book['category'] }}</td>
            <td>{{ book['status'] }}</td>
            <td>{{ book['rating'] or '' }}</td>
        </tr>
    {% endfor %}
    </tbody>

</table>

<script>

    async function searchBook(query) {
        const res = await fetch(`/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        console.log(data.results); //list of books
    }



    document.addEventListener("DOMContentLoaded", () => {
      const titleInput = document.getElementById("book-title");
      const authorInput = document.getElementById("book-author");
      const resultsBox = document.getElementById("autocomplete-results");
      let timer = null;

      titleInput.addEventListener("input", async function () {
        const query = this.value.trim();
        clearTimeout(timer);
        resultsBox.innerHTML = "";

        if (query.length < 2) return; // czekaj a≈º wpisze co≈õ sensownego

        timer = setTimeout(async () => {
          const res = await fetch(`/search?q=intitle:${encodeURIComponent(query)}`);
          const data = await res.json();
          const results = data.results || [];

          if (results.length === 0) return;

          resultsBox.innerHTML = results
            .map(book => `
              <div class="autocomplete-item"
                   data-title="${book.title}"
                   data-author="${(book.authors && book.authors[0]) || ''}"
                   data-category="${(book.categories && book.categories[0]) || ''}">
                ${book.thumbnail ? `<img src="${book.thumbnail}" alt="">` : ""}
                <div>
                  <strong>${book.title}</strong><br>
                  <small>${(book.authors && book.authors.join(", ")) || "Unknown author"}</small>
                </div>
              </div>
            `)
            .join("");

          // obs≈Çuga klikniƒôcia
          document.querySelectorAll(".autocomplete-item").forEach(item => {
            item.addEventListener("click", () => {
              titleInput.value = item.dataset.title;
              authorInput.value = item.dataset.author;
              document.querySelector('input[name="category"]').value = item.dataset.category || '';
              resultsBox.innerHTML = "";
            });
          });
        }, 300); // debounce 0.3s
      });

      // zamykamy listƒô przy klikniƒôciu poza
      document.addEventListener("click", (e) => {
        if (!resultsBox.contains(e.target) && e.target !== titleInput) {
          resultsBox.innerHTML = "";
        }
      });
    });




$(document).ready(function() {
    var table = $('#books-table').DataTable({
        paging: true,
        searching: false,
        ordering: true,
        language: {},
        pageLength: 10,
        rowCallback: function(row, data) {
            $(row).css('cursor', 'pointer');
            $(row).off('click').on('click', function() {
                const bookId = $(row).data('id');
                window.location.href = `/book/${bookId}`;
            });
        }
    });

    //search bar with tickboxes
    function customFilter(){

        // take what user has typed in
        const searchTerm = $('#custom-search').val().toLowerCase();

        //  check which checkboxes are checked
        //   $('.column-search-checkboxes input:checked') ‚Äì wszystkie zaznaczone inputy w divie z checkboxami
        //   .map(...) ‚Äì dla ka≈ºdego zaznaczonego checkboxa wyciƒÖga numer kolumny z data-column
        //   parseInt(...) ‚Äì zamieniamy string na liczbƒô
        //   .get() ‚Äì konwertuje wynik jQuery do normalnej tablicy JS
        const checkedColumns = $('.column-search-checkboxes input:checked')
            .map(function() {return parseInt($(this).data('column')); })
            .get();

        // take option from dropdown status
        const statusValue = $('#status-filter').val().toLowerCase();

        // rating from slider
        const minRating = parseFloat($('#rating-min').val()) || 0;
        const maxRating = parseFloat($('#rating-max').val()) || 10;

        //if nothing is ticked search everywhere
        const activeColumns = checkedColumns.length ? checkedColumns : [0,1,2,3,4,5];

        //check every cell in table
        table.rows().every(function(){
           const rowData = this.data();

           //check if text matches
           const textMatch = activeColumns.some(col=>
               (rowData[col] || '').toString().toLowerCase().includes(searchTerm)
           );

           //check if matches status
           const statusMatch = !statusValue || (rowData[4] || '').toLowerCase() === statusValue;

           //check if rating matches
            const rating = parseFloat(rowData[5]) || 0;
            const ratingMatch = rating >= minRating && rating <= maxRating;

           if ((textMatch || !searchTerm) && statusMatch && ratingMatch) {
               $(this.node()).show();
           } else {
               $(this.node()).hide();
           }
        });
    }

    // Events
    // if typed in search bar
    $('#custom-search').on('keyup', customFilter);

    // if tickbox changed
    $('.column-search-checkboxes input').on('change', customFilter);

    //if status changed
    $('#status-filter').on('change', customFilter);

    // rating slider logic
    const ratingMin = $('#rating-min');
    const ratingMax = $('#rating-max');
    const ratingDisplay = $('#rating-display');
    const sliderTrack = $('.slider-track');

    function updateSliderTrack() {
        const min = parseFloat(ratingMin.val());
        const max = parseFloat(ratingMax.val());
        const percentMin = (min / 10) * 100;
        const percentMax = (max / 10) * 100;
        sliderTrack.css({
            left: percentMin + '%',
            right: (100 - percentMax) + '%'
        });
        ratingDisplay.text(`${min} - ${max}`);
    }

    ratingMin.on('input', function() {
        if (parseFloat(ratingMin.val()) > parseFloat(ratingMax.val())) ratingMin.val(ratingMax.val());
        updateSliderTrack();
        customFilter();
    });

    ratingMax.on('input', function() {
        if (parseFloat(ratingMax.val()) < parseFloat(ratingMin.val())) ratingMax.val(ratingMin.val());
        updateSliderTrack();
        customFilter();
    });

    updateSliderTrack();
});
</script>

{% endblock %}
